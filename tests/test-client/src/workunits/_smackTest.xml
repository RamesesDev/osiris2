<?xml version="1.0" encoding="UTF-8"?>
<workunit>
    
    <invokers>
        <invoker folderid="/menu/smack" caption="Client 1" action="init"/>
    </invokers>
    
    <code>
        <![CDATA[
        
        import com.rameses.rcp.annotations.*;
        import com.rameses.rcp.common.*;
        import com.rameses.messaging.*;
        import test.smack.*;
        
                
        public class SmackTest1 {
            
            @Binding
            def binding;
            
            @Service("MessageService")
            def service;
        
            def message;
            def messageList = new StringBuffer();
                      
            def con;
            
            void init() {
                def conf = service.getConnectionConf("SmackConnection1");
                con = MessagingDelegate.getConnection(conf);
                con.open();
                con.addMessageListener( listener );
            }
            
            void send() {
                def m = con.createMessage(null);
                
                println "sending " + message;
                
                m.setText(message);
                m.setRecipient("paadmin@etracs.org");

                con.sendMessage(m);
                message = "";
            }
            
            def listener =[
                onMessage: { m ->
                    messageList.append( m.getBody() + "\n" );
                    binding.refresh();
                }
            ] as MessageListener;
            
            @Close
            def close() {
                con.close();
            }

        }
        
        ]]>
    </code>
    
    <pages>
        <page template="test.smack.Page"/>
    </pages>
</workunit>
